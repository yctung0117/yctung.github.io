<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>提交表單</title>
    <style>
        #previewModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        #previewContent {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
        }
        #submissionMessage {
            display: none;
            text-align: center;
            color: red;
        }
    </style>
    <script>
        function checkSubmissionStatus() {
            // 檢查 localStorage 中是否已有提交標記
            if (localStorage.getItem('formSubmitted') === 'true') {
                document.getElementById('submissionMessage').style.display = 'block';
                document.getElementById('locationForm').style.display = 'none';
            } else {
                document.getElementById('submissionMessage').style.display = 'none';
                document.getElementById('locationForm').style.display = 'block';
            }
        }

        function getLocationAndSubmit() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    // 填入 Google 表單的隱藏欄位
                    document.getElementById("latitude").value = position.coords.latitude;
                    document.getElementById("longitude").value = position.coords.longitude;

                    // 顯示預覽對話框
                    showPreview();
                }, function (error) {
                    alert("無法獲取位置：" + error.message);
                });
            } else {
                alert("此瀏覽器不支援地理位置API");
            }
        }

        function showPreview() {
            // 獲取用戶輸入的數據
            var name = document.getElementById("name").value;
            var studentID = document.getElementById("studentID").value;
            var latitude = document.getElementById("latitude").value;
            var longitude = document.getElementById("longitude").value;

            // 顯示預覽信息
            document.getElementById("previewName").textContent = "姓名: " + name;
            document.getElementById("previewStudentID").textContent = "學號: " + studentID;
            document.getElementById("previewLatitude").textContent = "緯度: " + latitude;
            document.getElementById("previewLongitude").textContent = "經度: " + longitude;

            // 隱藏座標的輸入框，顯示座標值
            document.getElementById("latitude").style.display = "none";
            document.getElementById("longitude").style.display = "none";

            // 顯示預覽對話框
            document.getElementById("previewModal").style.display = "flex";
        }

        function confirmSubmit() {
            // 標記已提交並提交表單
            localStorage.setItem('formSubmitted', 'true');
            document.getElementById("locationForm").submit();
        }

        function closePreview() {
            // 關閉預覽對話框
            document.getElementById("previewModal").style.display = "none";
        }
    </script>
</head>
<body onload="checkSubmissionStatus()">
    <h1>請允許我們存取您的位置</h1>

    <!-- 提交已經完成的訊息 -->
    <div id="submissionMessage">
        <h2>您已經提交過此表單。</h2>
        <p>感謝您的參與！</p>
    </div>

    <!-- Google 表單 -->
    <form id="locationForm" action="https://docs.google.com/forms/d/e/1FAIpQLSehVc7iQcX2NsE-lFzb9u8KuiLIgT5cZ5UF-Rir_PPa4yie3w/formResponse" method="POST" target="_self">
        <!-- 姓名欄位 -->
        <label for="name">姓名:</label>
        <input type="text" id="name" name="entry.263219938" required>
        
        <!-- 學號欄位 -->
        <label for="studentID">學號:</label>
        <input type="text" id="studentID" name="entry.426531116" required>
        
        <!-- 隱藏欄位，將座標傳送到 Google 表單對應的 entry ID -->
        <input type="hidden" id="latitude" name="entry.1430317296">
        <input type="hidden" id="longitude" name="entry.1940075456">
        
        <!-- 預覽按鈕 -->
        <button type="button" onclick="getLocationAndSubmit()">預覽填入信息</button>
    </form>

    <!-- 預覽對話框 -->
    <div id="previewModal">
        <div id="previewContent">
            <h2>請確認填入的信息</h2>
            <p id="previewName"></p>
            <p id="previewStudentID"></p>
            <p id="previewLatitude"></p>
            <p id="previewLongitude"></p>
            <button onclick="confirmSubmit()">確認提交</button>
            <button onclick="closePreview()">取消</button>
        </div>
    </div>
</body>
</html>
